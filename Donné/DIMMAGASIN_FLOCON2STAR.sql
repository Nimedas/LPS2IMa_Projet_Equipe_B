DROP TABLE DIM_MAGASIN_STAR CASCADE CONSTRANTS PURGE;
;

CREATE TABLE DIM_MAGASIN_STAR AS 
SELECT DISTINCT ID_MAGASIN, 
    ACTIF, 
    DATE_OUVERTURE , 
    DATE_FERMETURE , 
    DATE_MAJ , 
    EMPLACEMENTS , 
    NB_CAISSES , 
    VILLE , 
    FICHIER_IMAGE_CARTE_MAGASIN ,
  DIM_ENSEIGNE.ID_ENSEIGNE, 
  LIB_ENSEIGNE, 
    FICHIER_IMAGE_LOGO_ENSEIGNE,
  ID_DEPARTEMENT, 
    CODE_DEPARTEMENT, 
    LIB_DEPARTEMENT , 
    ANC_ADMIN.ID_REGION_ADMIN AS ID_REGION_ANC_ADMIN,
    ANC_ADMIN.LIB_REGION_ADMIN AS LIB_REGION_ANC_ADMIN, 
    ANC_ADMIN.DATE_DEBUT_VALID_ADMIN AS DATE_DEBUT_VALID_ANC_ADMIN, 
    ANC_ADMIN.DATE_FIN_VALID_ADMIN AS DATE_FIN_VALID_ANC_ADMIN, 
    ANC_ADMIN.FICHIER_IMAGE_CARTE_REGADM AS FICHIER_IMG_ANC_REG_ADMIN, 
  NOUV_ADMIN.ID_REGION_ADMIN AS ID_REGION_NOUV_ADMIN,
    NOUV_ADMIN.LIB_REGION_ADMIN AS LIB_REGION_NOUV_ADMIN, 
    NOUV_ADMIN.DATE_DEBUT_VALID_ADMIN AS DATE_DEBUT_VALID_NOUV_ADMIN, 
    NOUV_ADMIN.DATE_FIN_VALID_ADMIN AS DATE_FIN_VALID_NOUV_ADMIN, 
    NOUV_ADMIN.FICHIER_IMAGE_CARTE_REGADM AS FICHIER_IMG_NOUV_REG_ADMIN, 
  DIM_GEOGRAPHIQUE_COM.ID_REGION_COM, 
    LIB_REGION_COM, 
    DATE_DEBUT_VALID_COM , 
    DATE_FIN_VALID_COM , 
    FICHIER_IMAGE_CARTE_REGCOM
  FROM DIM_MAGASIN, DIM_ENSEIGNE, DIM_DEPARTEMENT, DIM_GEOGRAPHIQUE_COM, DIM_GEOGRAPHIQUE_ADMIN ANC_ADMIN, DIM_GEOGRAPHIQUE_ADMIN NOUV_ADMIN
  WHERE DIM_MAGASIN.ID_ENSEIGNE=DIM_ENSEIGNE.ID_ENSEIGNE
  AND DIM_DEPARTEMENT.ID_DEPARTEMENT=DIM_MAGASIN.DEP
  AND DIM_GEOGRAPHIQUE_COM.ID_REGION_COM=DIM_DEPARTEMENT.ID_REGION_COM
  AND ANC_ADMIN.ID_REGION_ADMIN=ID_REGION_ADMIN1
  AND NOUV_ADMIN.ID_REGION_ADMIN=ID_REGION_ADMIN2
  ;

--------------------------------------------------------
--  DDL for Index PK_DIM_MAGASIN
--------------------------------------------------------

  CREATE UNIQUE INDEX "PK_DIM_MAGASIN_STAR" ON "DIM_MAGASIN_STAR" ("ID_MAGASIN") ;
/
ALTER TABLE "DIM_MAGASIN_STAR" ADD CONSTRAINT "PK_DIM_MAGASIN_STAR" PRIMARY KEY ("ID_MAGASIN")
  USING INDEX COMPUTE STATISTICS ;
  
   COMMENT ON COLUMN "DIM_MAGASIN_STAR"."ID_MAGASIN" IS 'Identifiant du magasin';
   COMMENT ON COLUMN "DIM_MAGASIN_STAR"."ACTIF" IS 'statut d''activite du magasin';
   COMMENT ON COLUMN "DIM_MAGASIN_STAR"."DATE_OUVERTURE" IS 'Date d''ouverture du magasin';
   COMMENT ON COLUMN "DIM_MAGASIN_STAR"."DATE_FERMETURE" IS 'Date de fermeture du magasin';
   COMMENT ON COLUMN "DIM_MAGASIN_STAR"."DATE_MAJ" IS 'Date de derniere mise a jour des donnees du magasin';
   COMMENT ON COLUMN "DIM_MAGASIN_STAR"."EMPLACEMENTS" IS 'Emplacements - Elements d''adresse du magasin';
   COMMENT ON COLUMN "DIM_MAGASIN_STAR"."NB_CAISSES" IS 'Nombre de caisses dans le magasin';
   COMMENT ON COLUMN "DIM_MAGASIN_STAR"."VILLE" IS 'Ville du magasin';
   COMMENT ON COLUMN "DIM_MAGASIN_STAR"."FICHIER_IMAGE_CARTE_MAGASIN" IS 'Nom du fichier image de la carte du magasin';
   COMMENT ON TABLE "DIM_MAGASIN_STAR"  IS 'Les magasins (schema en etoile)';
   COMMENT ON COLUMN "DIM_MAGASIN_STAR"."ID_ENSEIGNE" IS 'Reference a l''enseigne du magasin';
   COMMENT ON COLUMN "DIM_MAGASIN_STAR"."ID_ENSEIGNE" IS 'Identifiant de l''enseigne du magasin';
   COMMENT ON COLUMN "DIM_MAGASIN_STAR"."LIB_ENSEIGNE" IS 'Libelle de l''enseigne';
   COMMENT ON COLUMN "DIM_MAGASIN_STAR"."FICHIER_IMAGE_LOGO_ENSEIGNE" IS 'Nom du fichier image du logo de l''enseigne';
   COMMENT ON COLUMN "DIM_MAGASIN_STAR"."ID_DEPARTEMENT" IS 'Identifiant du departement du magasin';
   COMMENT ON COLUMN "DIM_MAGASIN_STAR"."CODE_DEPARTEMENT" IS 'Code INSEE du departement';
   COMMENT ON COLUMN "DIM_MAGASIN_STAR"."LIB_DEPARTEMENT" IS 'Nom du departement';
   COMMENT ON COLUMN "DIM_MAGASIN_STAR"."ID_REGION_ANC_ADMIN" IS 'Identifiant de l''ancienne region administrative du magasin';
   COMMENT ON COLUMN "DIM_MAGASIN_STAR"."LIB_REGION_ANC_ADMIN" IS 'Libelle de l''ancienne region administrative';
   COMMENT ON COLUMN "DIM_MAGASIN_STAR"."DATE_DEBUT_VALID_ANC_ADMIN" IS 'Date de debut de validite de l''ancienne region administrative';
   COMMENT ON COLUMN "DIM_MAGASIN_STAR"."DATE_FIN_VALID_ANC_ADMIN" IS 'Date de fin de validite de l''ancienne region administrative';
   COMMENT ON COLUMN "DIM_MAGASIN_STAR"."FICHIER_IMG_ANC_REG_ADMIN" IS 'Nom du fichier image de la carte de l''ancienne region administrative';
   COMMENT ON COLUMN "DIM_MAGASIN_STAR"."ID_REGION_NOUV_ADMIN" IS 'Identifiant de la nouvelle region administrative';
   COMMENT ON COLUMN "DIM_MAGASIN_STAR"."LIB_REGION_NOUV_ADMIN" IS 'Libelle de la nouvelle region administrative';
   COMMENT ON COLUMN "DIM_MAGASIN_STAR"."DATE_DEBUT_VALID_NOUV_ADMIN" IS 'Date de debut de validite de la nouvelle region administrative';
   COMMENT ON COLUMN "DIM_MAGASIN_STAR"."DATE_FIN_VALID_NOUV_ADMIN" IS 'Date de fin de validite de la nouvelle region administrative';
   COMMENT ON COLUMN "DIM_MAGASIN_STAR"."FICHIER_IMG_NOUV_REG_ADMIN" IS 'Nom du fichier image de la carte de la nouvelle région administrative';
   COMMENT ON COLUMN "DIM_MAGASIN_STAR"."ID_REGION_COM" IS 'Identifiant de la region commerciale du magasin';
   COMMENT ON COLUMN "DIM_MAGASIN_STAR"."LIB_REGION_COM" IS 'Libelle de la region commerciale';
   COMMENT ON COLUMN "DIM_MAGASIN_STAR"."DATE_DEBUT_VALID_COM" IS 'Date de début de validite de la region commerciale';
   COMMENT ON COLUMN "DIM_MAGASIN_STAR"."DATE_FIN_VALID_COM" IS 'Date de fin de validite de la region commerciale';
   COMMENT ON COLUMN "DIM_MAGASIN_STAR"."FICHIER_IMAGE_CARTE_REGCOM" IS 'Nom du fichier image la carte de la région commerciale';

/

--------------------------------------------------------
--  DDL for Sequence ID_MAGASIN_STAR_SEQ
--------------------------------------------------------
CREATE SEQUENCE  "ID_MAGASIN_STAR_SEQ"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 CACHE 20 NOORDER  NOCYCLE  NOPARTITION ;
/

CREATE OR REPLACE EDITIONABLE TRIGGER "MAGASIN_STAR_ID" 
BEFORE INSERT ON DIM_MAGASIN_STAR
FOR EACH ROW
BEGIN
  IF :NEW.ID_MAGASIN IS NULL THEN
    SELECT ID_MAGASIN_STAR_SEQ.NEXTVAL
    INTO   :NEW.ID_MAGASIN
    FROM   dual;
  END IF;
END;
/
ALTER TRIGGER "MAGASIN_STAR_ID" ENABLE;
/

--------------------------------------------------------
--  DDL for Procedure SYNCHRO_ID_MAGASIN_STAR_SEQ
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "SYNCHRO_ID_MAGASIN_STAR_SEQ" 
AS
  IdMagasinCompteur DIM_MAGASIN_STAR.ID_MAGASIN%TYPE;
  seqcount integer;
BEGIN
  SELECT MAX(ID_MAGASIN)+ 1 INTO IdMagasinCompteur
  FROM DIM_MAGASIN_STAR;
    IF IdMagasinCompteur IS NULL THEN
    IdMagasinCompteur:=1;
  END IF;
  SELECT COUNT(*) INTO seqCount FROM user_sequences WHERE sequence_name='ID_MAGASIN_STAR_SEQ';
  IF seqcount=1 THEN
    execute immediate 'DROP SEQUENCE ID_MAGASIN_STAR_SEQ' ;
  END IF;
  execute immediate 'CREATE SEQUENCE ID_MAGASIN_STAR_SEQ START WITH '||IdMagasinCompteur|| ' INCREMENT BY 1';
END;

/

/

DROP TABLE FAITS_VENTES_STAR CASCADE CONSTRANTS PURGE;

CREATE TABLE FAITS_VENTES_STAR AS 
SELECT * FROM FAITS_VENTES;

   COMMENT ON COLUMN "FAITS_VENTES_STAR"."VENTES_OBJECTIF" IS 'Objectif pour les ventes';
   COMMENT ON COLUMN "FAITS_VENTES_STAR"."VENTES_REEL" IS 'Nombre de ventes realisees';
   COMMENT ON COLUMN "FAITS_VENTES_STAR"."CA_OBJECTIF" IS 'Objectif pour le chiffre d''affaires';
   COMMENT ON COLUMN "FAITS_VENTES_STAR"."CA_REEL" IS 'Chiffre d''affaires realise';
   COMMENT ON COLUMN "FAITS_VENTES_STAR"."MARGE_OBJECTIF" IS 'Objectif pour la marge';
   COMMENT ON COLUMN "FAITS_VENTES_STAR"."MARGE_REEL" IS 'Marge realisee';
   COMMENT ON COLUMN "FAITS_VENTES_STAR"."DATE_MAJ" IS 'date de derniere mise a jour';
   COMMENT ON TABLE "FAITS_VENTES_STAR"  IS 'Fait ventes (schema en etoile)';
  
  --------------------------------------------------------
--  DDL for Index PK_FAITS_VENTES
--------------------------------------------------------

  CREATE UNIQUE INDEX "PK_FAITS_VENTES_STAR" ON "FAITS_VENTES_STAR" ("ID_MAGASIN", "ID_FAMILLE_PRODUIT", "ID_TEMPS")  ;
/

  ALTER TABLE "FAITS_VENTES_STAR" ADD CONSTRAINT "PK_FAITS_VENTES_STAR" PRIMARY KEY ("ID_MAGASIN", "ID_FAMILLE_PRODUIT", "ID_TEMPS")
  USING INDEX COMPUTE STATISTICS ;
/

  ALTER TABLE "FAITS_VENTES_STAR" ADD CONSTRAINT "FK_FAITS_VENTES_SR_DIM_FAMILLE" FOREIGN KEY ("ID_FAMILLE_PRODUIT")
      REFERENCES "DIM_FAMILLE_PRODUIT" ("ID_FAMILLE_PRODUIT") ENABLE;
  ALTER TABLE "FAITS_VENTES_STAR" ADD CONSTRAINT "FK_FAITS_VENTES_SR_DIM_MAGASIN" FOREIGN KEY ("ID_MAGASIN")
      REFERENCES "DIM_MAGASIN_STAR" ("ID_MAGASIN") ENABLE;
  ALTER TABLE "FAITS_VENTES_STAR" ADD CONSTRAINT "FK_FAITS_VENTES_STAR_DIM_TEMPS" FOREIGN KEY ("ID_TEMPS")
      REFERENCES "DIM_TEMPS" ("ID_TEMPS") ENABLE;
/

--------------------------------------------------------
--  DDL for Table SECURITE
--------------------------------------------------------

DROP TABLE SECURITE_STAR CASCADE CONSTRANTS PURGE;

CREATE TABLE SECURITE_STAR AS 
SELECT * FROM SECURITE;

--------------------------------------------------------
--  DDL for Index PK_SECURITE
--------------------------------------------------------

  CREATE UNIQUE INDEX "PK_SECURITE_STAR" ON "SECURITE_STAR" ("ID_PROFIL", "ID_MAGASIN", "ONGLET")  ;
/

  ALTER TABLE "SECURITE_STAR" ADD CONSTRAINT "PK_SECURITE_STAR" PRIMARY KEY ("ID_PROFIL", "ID_MAGASIN", "ONGLET")
  USING INDEX COMPUTE STATISTICS ;
/
   COMMENT ON COLUMN "SECURITE_STAR"."ID_MAGASIN" IS 'Visibilite des donnees du magasin';
   COMMENT ON COLUMN "SECURITE_STAR"."ID_PROFIL" IS 'Visibilite du profil';
   COMMENT ON COLUMN "SECURITE_STAR"."ONGLET" IS 'Selon l''onglet du tableau de bord, des informations peuvent etre necessaires';
   COMMENT ON TABLE "SECURITE_STAR"  IS 'Visibilite en fonction du profil (schema en etoile)';
/

--------------------------------------------------------
--  Ref Constraints for Table SECURITE
--------------------------------------------------------

  ALTER TABLE "SECURITE_STAR" ADD CONSTRAINT "SECURITE_STAR_DIM_MAGASIN_FK" FOREIGN KEY ("ID_MAGASIN")
      REFERENCES "DIM_MAGASIN_STAR" ("ID_MAGASIN") ENABLE;
  ALTER TABLE "SECURITE_STAR" ADD CONSTRAINT "SECURITE_STAR_PROFIL_FK" FOREIGN KEY ("ID_PROFIL")
      REFERENCES "PROFIL" ("ID_PROFIL") ENABLE;
/